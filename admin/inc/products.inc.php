<?//<meta http-equiv="Content-Type" content="text/html; charset=utf8" /> if ($pAction == "load_price_list"){	if (!empty($_FILES)){		if ($_FILES["pricelist"]["error"] == 0){			$tmp_file = $_FILES["pricelist"]["tmp_name"];			$handle = fopen($tmp_file, "r");			$admin->db->query("UPDATE product_categories SET product_categories.display='n'");			$admin->db->query("UPDATE products SET products.display='n'");			while (($tmp = fgets($handle, 1000)) !== false){				$data=explode(";", $tmp);				/*				[0] => 31620				[1] => 31631				[2] => 13360198-5				[3] =>  				[4] => Пластырь для датчика дождя C-Сlass, W-203				[5] => шт.				[6] => EUR				[7] => 3				[8] => 5				*/				$data[2] = iconv("windows-1251","utf-8",$data[2]);				$data[4] = iconv("windows-1251","utf-8",$data[4]);				$data[5] = iconv("windows-1251","utf-8",$data[5]);								$item_id = (int)$data[0];				$item_pid = (int)$data[1];				$article = trim($data[2]);				$eurocode = $data[3];				$title = htmlspecialchars(trim($data[4]));				$translit = translit(_strtolower($title));				$units = (trim($data[5]));				$currency = (trim($data[6]));				$trade_price = (floatval($data[7]));// оптовая цена				$retail_price = (floatval($data[8]));// розничная цена								//if (($item_pid == 0) or ($article == "")){				if ($article == "" and $trade_price == 0 and $retail_price == 0){					$sql = "INSERT INTO product_categories(item_id,item_pid)VALUES({$item_id},{$item_pid})";										$is_id = $admin->db->selectCell("SELECT item_id FROM product_categories WHERE item_id={$item_id} AND item_pid={$item_pid}");					if ($is_id > 0){						$sql = "UPDATE product_categories SET product_categories.display='y' WHERE product_categories.item_id={$item_id} AND product_categories.item_pid={$item_pid}";					}					if ($sql != ""){$admin->db->query($sql);}					foreach ($admin->languages2 as $lang_id => $lang_prefix){						$sql_ext = "INSERT INTO product_categories_ext(item_master_id,lang,title,translit)VALUES({$item_id},{$lang_id},'{$title}','{$translit}')";												$is_ext_id = $admin->db->selectCell("SELECT item_master_id FROM product_categories_ext WHERE item_master_id={$item_id} AND lang={$lang_id}");						if ($is_ext_id > 0){							$sql_ext = "UPDATE product_categories_ext set title='{$title}',translit='{$translit}' WHERE item_master_id={$item_id} AND lang={$lang_id}";						}						$admin->db->query($sql_ext);											}				}				else{					if ($article != "" && $trade_price>0 && $retail_price>0){						$sql = "INSERT INTO products(item_id,category_master_id,eurocode,articul,currency,trade_price,retail_price)VALUES({$item_id},{$item_pid},'{$eurocode}','{$article}','{$currency}','{$trade_price}','{$retail_price}')";						$is_id = $admin->db->selectCell("SELECT item_id FROM products WHERE item_id={$item_id} AND category_master_id={$item_pid}");						if ($is_id > 0){							$sql = "UPDATE products SET display='y',articul='{$article}',currency='{$currency}',trade_price='{$trade_price}',retail_price='{$retail_price}' WHERE item_id={$item_id}";						}						//echo $sql;						if ($sql != ""){$admin->db->query($sql);}						foreach ($admin->languages2 as $lang_id => $lang_prefix){							$sql_ext = "INSERT INTO products_ext(item_master_id,lang,title,translit,units)VALUES({$item_id},{$lang_id},'{$title}','{$translit}','{$units}')";							$is_ext_id = $admin->db->selectCell("SELECT item_master_id FROM products_ext WHERE item_master_id={$item_id} AND lang={$lang_id}");							if ($is_ext_id > 0){								$sql_ext = "UPDATE products_ext SET title='{$title}',translit='{$translit}',units='{$units}' WHERE item_master_id={$item_id} AND lang={$lang_id}";							}							$admin->db->query($sql_ext);						}					}				}								//if ($sql != ""){$admin->db->query($sql);}								//echo "<div style='border:red 1px solid; margin:10px; padding:10px'>";				//echo "<h2>".$sql."</h2>";				//echo "<p>".$sql_ext."</p>";				//echo "</div>";			}			$admin->adminMessage = "Прайс-лист успешно импортирован";		}		else{			$admin->adminErrorMessage = "Ошибка!!! Не выбран файл";		}	}}if ($pAction == "update_category"){		$display = $_POST["category"]["display"];	$item_id = (int) $_POST["category"]["item_id"];	$item_pid = (int) $_POST["category"]["item_pid"];		if ($_POST["submit_mode"] == "set"){		$back_url = "?section=".$admin->section."&mode=edit_products_category&category_item_id=".$item_id;	}	else{		$back_url = "?section=".$admin->section."&category_item_id=".$item_pid;	}		$mainSQL = "UPDATE product_categories SET display='{$display}' WHERE item_id={$item_id}";	$admin->db->query($mainSQL);			/* удаление изображения для категории */	if (isset($_POST["category"]["drop_image"])){		if (!empty($_POST["category"]["drop_image"])){			@unlink(CATALOG_CATEGORIES_IMAGE_DIR.$_POST["category"]["drop_image"]);			$admin->db->query("UPDATE product_categories SET category_image='' WHERE item_id={$item_id}");		}	}		/* загрузка изображения для категории */	if (count($_FILES)>0){		if ($_FILES["category_image"]["error"] == 0){			include (LIBS_PATH."class.upload/class.upload.php");			$handle = new Upload($_FILES["category_image"]['tmp_name']);			$handle->allowed = array("image/*");			if ($handle->uploaded) {								$newFileName = md5(microtime());								# делаем маленькую картинку				$handle->image_resize = true;				$handle->image_ratio_y = true;				$handle->image_x = 130;					$handle->image_convert = 'jpg';				$handle->file_new_name_body=$newFileName;				$handle->file_new_name_ext='jpg';				$handle->Process(CATALOG_CATEGORIES_IMAGE_DIR);									if ($handle->processed){					$outFileName = $handle->file_dst_name_body.".".$handle->file_dst_name_ext;				}			}			if (!empty($outFileName)){				$image_sql = "UPDATE product_categories SET category_image='{$outFileName}' WHERE item_id={$item_id}";				$admin->db->query($image_sql);			}		}	}		foreach ($admin->languages2 as $lang_id => $lang_prefix){		$title = htmlspecialchars(clearvar($_POST["category"]["{$lang_id}"]["title"]));		$translit = (clearvar($_POST["category"]["{$lang_id}"]["translit"]));		$meta_title = (clearvar($_POST["category"]["{$lang_id}"]["meta_title"]));		$meta_description = (clearvar($_POST["category"]["{$lang_id}"]["meta_description"]));		$meta_keywords = (clearvar($_POST["category"]["{$lang_id}"]["meta_keywords"]));		$static_content = (clearvar($_POST["category"]["{$lang_id}"]["static_content"]));		if ($translit == ''){$translit = translit(_strtolower($title));}				$sql = "			UPDATE 			product_categories_ext			SET 			product_categories_ext.title='{$title}',			product_categories_ext.translit='{$translit}', 			product_categories_ext.meta_title='{$meta_title}', 			product_categories_ext.meta_description='{$meta_description}', 			product_categories_ext.meta_keywords='{$meta_keywords}',			product_categories_ext.static_content='{$static_content}' 			WHERE			product_categories_ext.item_master_id={$item_id}";				$admin->db->query($sql);	}		header("location:$back_url");	exit;}if ($pAction == "update_product"){	/*	Array	(		[product] => Array			(				[1] => Array					(						[title] => PT 310 Активатор для датчиков 1000 мл						[translit] => pt-310-aktivator-dlya-datchikov-1000-ml						[units] => шт.					)	 				[display] => y				[eurocode] => 0				[currency] => EUR				[trade_price] => 44.00				[retail_price] => 50.00				[item_id] => 31492				[category_master_id] => 31631			)	 		[pAction] => update_product		[submit_mode] => save	)	*/	//print_r($_POST); exit;		$display = $_POST["product"]["display"];	$eurocode = $_POST["product"]["eurocode"];	$currency = $_POST["product"]["currency"];	$trade_price = floatval($_POST["product"]["trade_price"]);	$retail_price = floatval($_POST["product"]["retail_price"]);	$item_id = (int) $_POST["product"]["item_id"];	$category_master_id = (int) $_POST["product"]["category_master_id"];		if ($_POST["submit_mode"] == "set"){		$back_url = "?section=".$admin->section."&mode=edit_product&product_item_id=".$item_id;	}	else{		$back_url = "?section=".$admin->section."&category_item_id=".$category_master_id;	}		$mainSQL = "		UPDATE products SET 		products.display='{$display}',		products.eurocode='{$eurocode}',		products.currency='{$currency}',		products.trade_price='{$trade_price}',		products.retail_price='{$retail_price}'		WHERE 		products.item_id={$item_id}		";	$admin->db->query($mainSQL);		foreach ($admin->languages2 as $lang_id => $lang_prefix){		$title = htmlspecialchars(clearvar($_POST["product"]["{$lang_id}"]["title"]));		$translit = (clearvar($_POST["product"]["{$lang_id}"]["translit"]));		$units = (clearvar($_POST["product"]["{$lang_id}"]["units"]));		if ($translit == ''){$translit = translit(_strtolower($title));}		$meta_title = (clearvar($_POST["product"]["{$lang_id}"]["meta_title"]));		$meta_description = (clearvar($_POST["product"]["{$lang_id}"]["meta_description"]));		$meta_keywords = (clearvar($_POST["product"]["{$lang_id}"]["meta_keywords"]));						$sql = "			UPDATE products_ext 			SET 			products_ext.title='{$title}',			products_ext.translit='{$translit}', 			products_ext.meta_title='{$meta_title}', 			products_ext.meta_description='{$meta_description}', 			products_ext.units='{$units}', 			products_ext.meta_keywords='{$meta_keywords}'			WHERE 			products_ext.item_master_id={$item_id}			";		$admin->db->query($sql);	}		//echo $back_url;	header("location:$back_url");	exit;}if (!$admin->mode){		$category_item_id = (int)$category_item_id;		$check_subCats_sql = "SELECT item_id FROM product_categories WHERE item_pid={$category_item_id}";		$subCats = $admin->db->select($check_subCats_sql);				$check_sub_products = $admin->db->select("SELECT item_id FROM products WHERE category_master_id={$category_item_id}");				//print_r($check_sub_products);				//if (count($subCats)>0){		if (count($check_sub_products)==0){						$categories = array();						$sql = "				SELECT 				product_categories.id,				product_categories.item_id,				product_categories.item_pid,				product_categories.display				FROM 				product_categories				WHERE 				product_categories.item_pid={$category_item_id}					";			$tmp = $admin->db->select($sql);						foreach ($tmp as $key => $value){				$categories["{$value["item_id"]}"]["item_id"] = $value["item_id"];				$categories["{$value["item_id"]}"]["item_pid"] = $value["item_pid"];				$categories["{$value["item_id"]}"]["display"] = $value["display"];				$categories["{$value["item_id"]}"]["edit_url"] = "?section=".$admin->section."&mode=edit_products_category&category_item_id=".$value["item_id"];				$categories["{$value["item_id"]}"]["ext"] = array();				foreach ($admin->languages2 as $lang_id => $lang_prefix){					$title = $admin->db->selectCell("SELECT product_categories_ext.title FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$value["item_id"]} AND product_categories_ext.lang={$lang_id}");					$ext["{$lang_id}"]["title"] = $title;					$categories["{$value["item_id"]}"]["ext"] = $ext;				}			}						$smarty->assign("categories",$categories);		}		else{			//SELECT `id`, `item_id`, `category_master_id`, `eurocode`, `currency`, `trade_price`, `retail_price` FROM `pmatools`.`products` LIMIT 0, 1000;			//echo "PRODS";			$products = array();						$sql = "				SELECT 				products.item_id,				products.category_master_id,				products.display,				products.eurocode,				products.currency,				products.trade_price,				products.retail_price				FROM 				products				WHERE 				products.category_master_id={$category_item_id}					";			$tmp = $admin->db->select($sql);						foreach ($tmp as $key => $value){				$products["{$value["item_id"]}"]["item_id"] = $value["item_id"];				$products["{$value["item_id"]}"]["category_master_id"] = $value["category_master_id"];				$products["{$value["item_id"]}"]["display"] = $value["display"];				$products["{$value["item_id"]}"]["eurocode"] = $value["eurocode"];				$products["{$value["item_id"]}"]["currency"] = $value["currency"];				$products["{$value["item_id"]}"]["rate"] = $rate = getRate($value["currency"]);				$products["{$value["item_id"]}"]["trade_price"] = $value["trade_price"];				$products["{$value["item_id"]}"]["retail_price"] = $value["retail_price"];				$products["{$value["item_id"]}"]["edit_url"] = "?section=".$admin->section."&mode=edit_product&product_item_id=".$value["item_id"];				$products["{$value["item_id"]}"]["ext"] = array();				foreach ($admin->languages2 as $lang_id => $lang_prefix){					//SELECT `id`, `item_master_id`, `lang`, LEFT(`title`, 256), `translit`, `units` FROM `pmatools`.`products_ext` LIMIT 0, 1000;					$title = $admin->db->selectCell("SELECT products_ext.title FROM  products_ext WHERE products_ext.item_master_id = {$value["item_id"]} AND products_ext.lang={$lang_id}");					$ext["{$lang_id}"]["title"] = $title;					$products["{$value["item_id"]}"]["ext"] = $ext;				}			}						//print_r($products);			$smarty->assign("products",$products);					}}else{	if ($admin->mode == "edit_products_category"){		if ($category_item_id > 0){			//CATALOG_CATEGORIES_IMAGE_PATH;			$category = $admin->db->selectRow("SELECT product_categories.* FROM product_categories WHERE item_id={$category_item_id}");			$category["ext"] = array();			foreach ($admin->languages2 as $lang_id => $lang_prefix){				$title = $admin->db->selectCell("SELECT product_categories_ext.title FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");				$translit = $admin->db->selectCell("SELECT product_categories_ext.translit FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");								$meta_title = $admin->db->selectCell("SELECT product_categories_ext.meta_title FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");				$meta_description = $admin->db->selectCell("SELECT product_categories_ext.meta_description FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");				$meta_keywords = $admin->db->selectCell("SELECT product_categories_ext.meta_keywords FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");				$static_content = $admin->db->selectCell("SELECT product_categories_ext.static_content FROM  product_categories_ext WHERE product_categories_ext.item_master_id = {$category_item_id} AND product_categories_ext.lang={$lang_id}");				$ext["{$lang_id}"]["title"] = $title;				$ext["{$lang_id}"]["translit"] = $translit;								$ext["{$lang_id}"]["meta_title"] = $meta_title;				$ext["{$lang_id}"]["meta_description"] = $meta_description;				$ext["{$lang_id}"]["meta_keywords"] = $meta_keywords;				$ext["{$lang_id}"]["static_content"] = $static_content;								$category["ext"] = $ext;			}			//print_r($category);			$smarty->assign("category",$category);		}	}	if ($admin->mode == "edit_product"){		if ($product_item_id > 0){			$product = $admin->db->selectRow("SELECT products.* FROM products WHERE item_id={$product_item_id}");			$product["ext"] = array();			$product["photos"] = array();			foreach ($admin->languages2 as $lang_id => $lang_prefix){				$ext_tmp = $admin->db->selectRow("SELECT products_ext.* FROM  products_ext WHERE products_ext.item_master_id = {$product_item_id} AND products_ext.lang={$lang_id}");				$ext["{$lang_id}"]["title"] = $ext_tmp["title"];				$ext["{$lang_id}"]["translit"] = $ext_tmp["translit"];				$ext["{$lang_id}"]["units"] = $ext_tmp["units"];								$ext["{$lang_id}"]["meta_title"] = $ext_tmp["meta_title"];				$ext["{$lang_id}"]["meta_description"] = $ext_tmp["meta_description"];				$ext["{$lang_id}"]["meta_keywords"] = $ext_tmp["meta_keywords"];								$product["ext"] = $ext;			}			$photos_tmp = $admin->db->select("SELECT products_photos.id,products_photos.file FROM products_photos WHERE products_photos.product_item_id={$product_item_id} order by products_photos.sorting ASC");			foreach($photos_tmp as $key => $value){				$photos["{$value["id"]}"]["id"] = $value["id"];				$photos["{$value["id"]}"]["file"] = $value["file"];			}			$product["photos"] = $photos;		}		//print_r($product);		$smarty->assign("product",$product);	}}?>