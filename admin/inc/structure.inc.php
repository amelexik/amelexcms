<?if (empty($gId)){	$gId = 0;}if (empty($parent_id)){$parent_id = 0;}$smarty->assign("parent_id",$parent_id);if (!empty($gAction)){	if ($gAction == "dropStructureItem"){		if ($id>0){			$tmp = $admin->db->selectRow("SELECT pid FROM structure WHERE id={$id}");			$parent_id = (int)$tmp["pid"];			$sql_main = "DELETE FROM structure WHERE id={$id}";			$admin->db->query($sql_main);			foreach ($admin->languages2 as $lang_id => $lang_prefix){				$sql = "DELETE FROM structure_ext WHERE lang={$lang_id} AND master_id={$id}";				$admin->db->query($sql);			}		}		$back_url = "?section=".$admin->section."&parent_id=".$parent_id;		header("location:$back_url");		exit();	}}if (!empty($pAction)){		if ($pAction == "add_structure_item" or $pAction == "update_structure_item"){				/*for table 'structure'*/		$parent_id = (int)$_POST["parent_id"];		$sorting = (int)$_POST["sorting"];		$template = trim($_POST["item"]["template"]);				if ($pAction == "add_structure_item"){			$mainSQL = "INSERT INTO structure(pid, sorting, template, add_date) VALUES ($parent_id,$sorting,'$template',CURRENT_TIMESTAMP())";			$admin->db->query($mainSQL);			$insert_id = (int) mysql_insert_id();		}				if ($pAction == "update_structure_item"){			$mainSQL = "UPDATE structure SET sorting={$sorting},template='{$template}' WHERE id={$structure_item_id}";			$admin->db->query($mainSQL);		}								/*for table 'structure_ext'*/		foreach ($admin->languages2 as $lang_id => $lang_prefix){			$lang = (int) $lang_id;			$display = clearvar($_POST["item"][$lang_id]["display"]);			$name = clearvar($_POST["item"][$lang_id]["name"]);			$translit = clearvar($_POST["item"][$lang_id]["translit"]);			if ($translit == ''){$translit = translit(_strtolower($name));}			$title = clearvar($_POST["item"][$lang_id]["title"]);			$description = clearvar($_POST["item"][$lang_id]["description"]);			$keywords = clearvar($_POST["item"][$lang_id]["keywords"]);									if (!empty($_POST["banners"]["{$lang_id}"])){				$count_banners = (int)count($_POST["banners"]["{$lang_id}"]);				$banners_serialize = "";				if ($count_banners>0){					$banners_serialize = serialize($_POST["banners"]["{$lang_id}"]);					//$banners_serialize = json_encode($_POST["banners"]["{$lang_id}"]);				}			}												if ($pAction == "add_structure_item"){				$sql = "INSERT INTO structure_ext (master_id, lang,display,translit,name,title,description,keywords,banners) VALUES ($insert_id,$lang,'$display','$translit','$name','$title','$description','$keywords','$banners_serialize')";				$admin->db->query($sql);			}						if ($pAction == "update_structure_item"){				$sql = "UPDATE structure_ext SET name='{$name}', title='{$title}', description='{$description}', keywords='{$keywords}', translit='{$translit}', display='{$display}',banners='{$banners_serialize}' WHERE master_id={$structure_item_id} AND lang={$lang_id}";				$admin->db->query($sql);			}					}				if ($pAction == "add_structure_item"){$back_url = "?section=structure&parent_id={$parent_id}";}		if ($pAction == "update_structure_item"){$back_url = "?section=structure&parent_id={$parent_id}";}		///////////////////////////////////////////////////////////		header("location:$back_url");		exit;	}		if($pAction == "set_static_content"){		$back_url = '';		if ($submit_mode == "set"){			$back_url = "";		}		if ($submit_mode == "save"){			$back_url = "?section=structure&parent_id=".$parent_id;		}				foreach($_POST["content"] as $lang_id => $content){			$content = addslashes($content);			$is_row = $admin->db->selectRow("SELECT * FROM pages WHERE master_id={$item_id} AND lang={$lang_id}");			if (count($is_row)>0){				$sql = "UPDATE pages SET content='{$content}' WHERE master_id={$item_id} AND lang={$lang_id}";			}			else{				$sql = "INSERT INTO pages (master_id,lang,content) VALUES ({$item_id},{$lang_id},'{$content}')";			}			$admin->db->query($sql);		}						if ($back_url != ''){			header("location:$back_url");			exit;		}	}}if (!$admin->mode){	$structure = array();	$tmp = $admin->db->select("SELECT * FROM structure WHERE pid={$parent_id} ORDER by sorting");	if (!empty($tmp)){		foreach($tmp as $key => $item){			$structure["{$item["id"]}"]["id"] = $item["id"];			$structure["{$item["id"]}"]["pid"] = $item["pid"];			$structure["{$item["id"]}"]["sorting"] = $item["sorting"];			$structure["{$item["id"]}"]["template"] = $item["template"];			$structure["{$item["id"]}"]["add_date"] = $item["add_date"];			$structure["{$item["id"]}"]["up_date"] = $item["up_date"];						$edit_url = '';						if ($item["template"] == 'page' or $item["template"] == 'feedback' ){				$edit_url = "?section=".$admin->section."&mode=edit_static_content&item_id=".$item["id"]."&parent_id=".$item["pid"];			}						if ($item["template"] == 'articles'){				$edit_url = "?section=articles&structure_master_id=".$item["id"];			}						if ($item["template"] == 'photo'){				$edit_url = "?section=photo&structure_master_id=".$item["id"];			}						if ($item["template"] == 'gallery'){				$edit_url = "?section=gallery&structure_master_id=".$item["id"];			}						if ($item["template"] == 'products'){				$edit_url = "?section=products&structure_master_id=".$item["id"];			}						$structure["{$item["id"]}"]["edit_url"] = $edit_url;						foreach($admin->languages2 as $lang_id => $lang_prefix){				$structure_ext_data = $admin->db->selectRow("SELECT structure_ext.name, structure_ext.translit, structure_ext.display FROM structure_ext WHERE structure_ext.master_id={$item["id"]} AND structure_ext.lang={$lang_id}");				$structure["{$item["id"]}"]["ext"]["{$lang_id}"]["name"] = stripslashes($structure_ext_data["name"]);				$structure["{$item["id"]}"]["ext"]["{$lang_id}"]["translit"] = $structure_ext_data["translit"];				$structure["{$item["id"]}"]["ext"]["{$lang_id}"]["display"] = ($structure_ext_data["display"]);				$structure["{$item["id"]}"]["ext"]["{$lang_id}"]["url"] = get_url(array("id"=>$item["id"], "lang"=>$lang_id));			}					}	}	//print_r($structure);	$smarty->assign("structure",$structure);	$admin->breadCrumbs = $admin->breadCrumbs($parent_id);}else{	if ($admin->mode == "add_edit_structure_item"){				if ($structure_item_id > 0){											$item = array();			$mainData = $admin->db->selectRow("SELECT * FROM structure WHERE id={$structure_item_id}");						$item["id"] = $mainData["id"];			$item["pid"] = $mainData["pid"];			$item["sorting"] = $mainData["sorting"];			$item["template"] = $mainData["template"];						foreach($admin->languages2 as $lang_id => $lang_prefix){				$item_ext_data = $admin->db->selectRow("SELECT structure_ext.* FROM structure_ext WHERE structure_ext.master_id={$item["id"]} AND structure_ext.lang={$lang_id}");				$item_ext_data["content"] = stripslashes($item_ext_data["content"]);								$structure_items_banners["{$lang_id}"] = unserialize($item_ext_data["banners"]);				//print_r($structure_items_banners);								$item["ext"]["{$lang_id}"] = $item_ext_data;			}						$banners_sql = "SELECT banners.id,banners.sorting FROM banners ORDER by banners.sorting ASC";				$banners = $admin->db->select($banners_sql);			if (count($banners)>0){				foreach($banners as $key => $banner){					$banner_master_id = (int)$banner["id"];					foreach($admin->languages2 as $lang_id => $lang_prefix){						$banners_ext_sql = "							SELECT 							banners_ext.master_id,							banners_ext.title,							banners_ext.display							FROM 							banners_ext							WHERE banners_ext.master_id={$banner_master_id}						";						$banner_ext = $admin->db->selectRow($banners_ext_sql);												if (in_array($banner["id"],$structure_items_banners["{$lang_id}"])){							$banner_ext["checked"] = "checked";						}						$banners[$key]["ext"][$lang_id] = $banner_ext;											}				}			}			//print_r($banners);			$smarty->assign("banners",$banners);												//print_r($item);			$smarty->assign("item",$item);					}		else{			$tmp = $admin->db->selectRow("SELECT MAX(sorting)FROM structure WHERE pid={$parent_id}");			$sorting = (int) $tmp["MAX(sorting)"];			$newSorting = $sorting+1;			//$smarty->assign("sorting",$newSorting);			$item["sorting"] = $newSorting;			$smarty->assign("item",$item);		}		//print_r($item);	}	if ($admin->mode == "edit_static_content"){		$content = array();		foreach($admin->languages2 as $lang_id => $lang_prefix){			$content["{$lang_id}"] = "";			if ($item_id>0){				$tmp = $admin->db->selectRow("SELECT content FROM pages WHERE master_id={$item_id} AND lang={$lang_id}");				if (count($tmp)>0){					$content["{$lang_id}"] = stripslashes($tmp["content"]);				}			}		}		$smarty->assign("content",$content);	}}?>