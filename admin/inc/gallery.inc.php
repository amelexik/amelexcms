<?if (!empty($gAction)){	if ($gAction == "drop_album"){		$back_url = "?section=".$admin->section."&structure_master_id=".$structure_master_id;		if($album_id>0){			$sql_1 = "DELETE FROM photoalbums WHERE id={$album_id}";			$sql_2 = "DELETE FROM photoalbums_ext WHERE master_id={$album_id}";			//$sql_3 = "DELETE FROM photo WHERE master_id={$album_id}";			//$photo_ext = $admin->db->select("SELECT id, lang FROM photo_ext WHERE ");			//echo $sql_1."<br>";			//echo $sql_2."<br>";			//echo $sql_3."<br>";			$admin->db->query($sql_1);			$admin->db->query($sql_2);					}		header("location:$back_url");		exit();	}	if ($gAction == "drop_photo"){		/*			[section] => gallery			[gAction] => drop_photo			[photo_master_id] => 51			[album_id] => 9			[structure_master_id] => 7		*/		if ($photo_master_id>0 && $album_id>0 && $structure_master_id>0){			$back_url = "?section=".$admin->section."&mode=album_content&album_id=".$album_id."&structure_master_id=".$structure_master_id;			$file = $admin->db->selectCell("SELECT file FROM photo WHERE id={$photo_master_id}");			$sql_1 = "DELETE FROM photo WHERE id={$photo_master_id}";			$sql_2 = "DELETE FROM photo_ext WHERE photo_master_id={$photo_master_id}";			$admin->db->query($sql_1);			$admin->db->query($sql_2);			if (!empty($file)){				@unlink($admin->gallery_dir.$file);				@unlink($admin->gallery_thumbs_dir.$file);			}		}				if (!empty($back_url)){			header("location:$back_url");			exit();		}			}}if (!empty($pAction)){	if ($pAction == "add_album" or $pAction == "update_album"){				$structure_master_id = (int)clearvar($_POST["item"]["structure_master_id"]);// from HIDDEN field		$display = clearvar($_POST["item"]["display"]);				if ($pAction == "add_album"){			$back_url = "?section=".$admin->section."&structure_master_id=".$structure_master_id;		}		if ($pAction == "update_album"){			$back_url = "?section=".$admin->section."&structure_master_id=".$structure_master_id;		}							$mainSQL = "INSERT INTO photoalbums (display,structure_master_id)VALUES('{$display}',{$structure_master_id})";		$admin->db->query($mainSQL);		$insert_id = (int) mysql_insert_id(); //$insert_id = 876;		if ($insert_id>0){			foreach ($admin->languages2 as $lang_id => $lang_prefix){				$title = htmlspecialchars(clearvar($_POST["item"][$lang_id]["title"]));				$sql = "INSERT INTO photoalbums_ext(master_id,title,lang)VALUES('{$insert_id}','{$title}','{$lang_id}')";				$admin->db->query($sql);//echo $sql."<br>";			}		}				header("location:$back_url");		exit();		}		if($pAction == "update_album_photos"){		foreach($_POST["item"] as $lang_id => $items){			foreach($items as $photo_master_id => $value){				//echo "lang_id--> ".$lang_id." photo_master_id--> ".$photo_master_id." description--> ".$value["description"]."<br>";				$description = clearvar($value["description"]);				$sql = "UPDATE photo_ext SET photo_ext.description='{$description}' WHERE photo_ext.photo_master_id={$photo_master_id} AND photo_ext.lang={$lang_id}";				//echo $sql."<br>";				$admin->db->query($sql);			}		}	}}if (!$admin->mode){	$albums = array();	if ($structure_master_id>0){				$tmp = $admin->db->select("SELECT * FROM photoalbums WHERE photoalbums.structure_master_id={$structure_master_id} ORDER by add_date DESC");			if (!empty($tmp)){				foreach($tmp as $key => $item){										$albums["{$item["id"]}"]["id"] = $item["id"];					$albums["{$item["id"]}"]["add_date"] = $item["add_date"];					if ($item["id"] > 0){						foreach($admin->languages2 as $lang_id => $lang_prefix){							$album_ext_data = $admin->db->selectRow("SELECT photoalbums_ext.title FROM photoalbums_ext WHERE photoalbums_ext.master_id={$item["id"]} AND photoalbums_ext.lang={$lang_id}");							$albums["{$item["id"]}"]["ext"]["{$lang_id}"]["title"] = stripslashes($album_ext_data["title"]);						}					}					$albums["{$item["id"]}"]["display"] = $item["display"];					$albums["{$item["id"]}"]["structure_master_id"] = $item["structure_master_id"];										$albums["{$item["id"]}"]["edit_photos_url"] = "?section=".$admin->section."&mode=album_content&album_id=".$item["id"]."&structure_master_id={$structure_master_id}";				}			}	}	$smarty->assign("albums",$albums);	}else{	if ($admin->mode == "add_edit_album"){		if ($album_id > 0){			$item = array();			$mainData = $admin->db->selectRow("SELECT * FROM photoalbums WHERE id={$album_id}");						$item["id"] = $mainData["id"];			$item["add_date"] = $mainData["add_date"];			$item["display"] = $mainData["display"];						foreach($admin->languages2 as $lang_id => $lang_prefix){				$item_ext_data_tmp = $admin->db->selectRow("SELECT photoalbums_ext.title FROM photoalbums_ext WHERE photoalbums_ext.master_id={$album_id} AND photoalbums_ext.lang={$lang_id}");				$item["ext"]["{$lang_id}"] = $item_ext_data_tmp;			}			//print_r($item);			$smarty->assign("item",$item);		}	}	if ($admin->mode == "album_content"){		if ($album_id > 0){			$photos = array();			$tmp = $admin->db->select("SELECT photo.id,photo.album_master_id,photo.file FROM photo WHERE photo.album_master_id={$album_id} ORDER BY id DESC");			foreach($tmp as $key => $value){				$photos["{$value["id"]}"]["id"] = $value["id"];				$photos["{$value["id"]}"]["file"] = $value["file"];				foreach($admin->languages2 as $lang_id => $lang_prefix){					$ext_tmp = $admin->db->selectRow("SELECT photo_ext.* FROM photo_ext WHERE photo_ext.photo_master_id={$value["id"]} AND photo_ext.lang={$lang_id}");					$photos["{$value["id"]}"]["ext"]["{$lang_id}"] = $ext_tmp;				}			}			//print_r($photos);			$smarty->assign("photos",$photos);		}	}	}?>